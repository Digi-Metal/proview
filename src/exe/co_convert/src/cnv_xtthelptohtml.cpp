/* cnv_xtthelptohtml.cpp --

   PROVIEW/R
   Copyright (C) 1996-98 by Mandator AB.

   Convert xtt help file to html. */

/*_Include files_________________________________________________________*/

#include <iostream.h>
#include <fstream.h>
#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <stdlib.h>

extern "C" {
#include "co_cdh.h"
#include "co_dcli.h"
}

#include "co_nav_help.h"
#include "cnv_ctx.h"
#include "cnv_readxtthelp.h"
#include "cnv_xtthelptohtml.h"

#define CNV_TAB 18

/* Nice functions */
#define ODD(a)	(((int)(a) & 1) != 0)
#define EVEN(a)	(((int)(a) & 1) == 0)
#define max(Dragon,Eagle) ((Dragon) > (Eagle) ? (Dragon) : (Eagle))
#define min(Dragon,Eagle) ((Dragon) < (Eagle) ? (Dragon) : (Eagle))
#ifndef __ALPHA
#define abs(Dragon) ((Dragon) >= 0 ? (Dragon) : (-(Dragon)))
#endif

void CnvXtthelpToHtml::subject_to_fname( char *fname, char *subject, int path)
{
  char *s, *t;

  if ( path) {
    strcpy( fname, ctx->dir);
    strcat( fname, ctx->rx->name);
  }
  else
    strcpy( fname, ctx->rx->name);
  strcat( fname, "_");
  t = fname + strlen(fname);
  for ( s = subject; *s; s++,t++) {
    if ( *s == ' ' || *s == '(' || *s == ')')
      *t = '_';
    else
      *t = *s;
  }
  *t = 0;
  strcat( fname, ".html");
  cdh_ToLower( fname, fname);
}

void *CnvXtthelpToHtml::insert( navh_eItemType item_type, char *text1,
				char *text2, char *text3, char *link, 
				char *link_bookmark, char *file_name,
				navh_eHelpFile file_type, int help_index, 
				char *bookmark)
{
  int i;
  static int in_table = 0;

  if ( (text2 && strcmp(text2, "") != 0) || 
       (text3 && strcmp(text3, "") != 0) ) {
    if ( !in_table) {
      fp << "<TABLE>" << endl;
      in_table = 1;
    }
  }
  else {
    if ( in_table) {
      // Close table (keep if empty line) 
      if ( !( text1 && strcmp( text1, "") == 0 && 
	      (item_type == navh_eItemType_Help || 
	       item_type == navh_eItemType_HelpCode || 
	       item_type == navh_eItemType_HelpBold))) {
        fp << "</TABLE>" << endl;
        in_table = 0;
      }
    }
  }
  switch ( item_type) {
    case navh_eItemType_Topic:
    {
      pwr_tFileName fname;

      subject_to_fname( fname, text1, 1);
      fp.open( fname);
      fp <<
"<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\"\"http://www.w3.org/TR/REC-html40/loose.dtd>" << endl <<
"<!--NewPage-->" << endl <<
"<HTML>" << endl <<
"<HEAD>" << endl <<
"<!-- Generated by co_convert.-->" << endl <<
"<TITLE>" << endl <<
"Generated Documentation (Untitled)" << endl <<
"</TITLE>" << endl <<
"<LINK REL =\"stylesheet\" TYPE=\"text/css\" HREF=\"pwr_css.css\" TITLE=\"Style\">" << endl <<
"</HEAD>" << endl <<
	//"<H2>" << text1 << "</H2><BR>" << endl <<
"<P>" << endl;
      return NULL;
    } 
    case navh_eItemType_EndTopic:
    {
      fp.close();
      return NULL;
    }
    case navh_eItemType_Help:
    case navh_eItemType_HelpCode:
    {      

      if ( strcmp( link, "") != 0) {
        pwr_tFileName fname;

	if ( strncmp( link, "$web:", 5) == 0) {
	  if ( strncmp( &link[5], "$pwrp_web/", 10) == 0)
	    strcpy( fname, &link[15]);
	  else
	    strcpy( fname, &link[5]);
	} 
        else if ( (strstr( link, ".htm") != 0) || 
		  (strstr( link, ".pdf") != 0)) {
          strcpy( fname, link);
        }
        else {
          subject_to_fname( fname, link, 0);
        
          if ( strcmp( link_bookmark, "") != 0) {
	    strcat( fname, "#");
	    strcat( fname, link_bookmark);
          }
        }
        fp << "<A HREF=\"" <<  fname << "\">";
      }
      else if ( bookmark) {
        fp << "<A NAME=\"" << bookmark << "\">";
      }

      if ( ! in_table) {
        fp << text1;
        if ( strcmp( link, "") != 0 || bookmark)
          fp << "<BR></A>" << endl;
        else
          fp << "<BR>" << endl;
      }
      else {
	fp << "<TR><TD>" << text1;
        if ( strcmp( text2, "") != 0 || strcmp( text3, "") != 0) {
          for ( i = 0; i < (int)(CNV_TAB - strlen(text1)); i++)
            fp << "&nbsp;";
          fp << "&nbsp;&nbsp;</TD><TD>" << text2;
          if ( strcmp( text3, "") != 0) {
            for ( i = 0; i < (int)(CNV_TAB - strlen(text2)); i++)
              fp << "&nbsp;";
            fp << "&nbsp;&nbsp;</TD><TD>" << text3;
          }
        }
        fp << "</TD></TR>";
        if ( strcmp( link, "") != 0 || bookmark)
          fp << "</A>" << endl;
        else
          fp << endl;
      }
      return NULL;
    }
    case navh_eItemType_HelpBold:
    {
      pwr_tFileName fname;
      if ( strcmp( link, "") != 0) {
	if ( strncmp( link, "$web:", 5) == 0) {
	  if ( strncmp( &link[5], "$pwrp_web/", 10) == 0)
	    strcpy( fname, &link[15]);
	  else
	    strcpy( fname, &link[5]);
	} 
        else if ( (strstr( link, ".htm") != 0) || 
		  (strstr( link, ".pdf") != 0)) {
          strcpy( fname, link);
        }
        else {
          subject_to_fname( fname, link, 0);
          if ( strcmp( link_bookmark, "") != 0) {
	    strcat( fname, "#");
	    strcat( fname, link_bookmark);
          }
        }
        if ( !in_table)
          fp << "<A HREF=\"" <<  fname << "\">";
      }
      else if ( bookmark) {
	if ( !in_table)
          fp << "<A NAME=\"" << bookmark << "\">";
      }

      if ( ! in_table) {
        fp << "<B>" << text1 << "</B>"; 
        if ( strcmp( link, "") != 0 || bookmark)
          fp<< "<BR></A>" << endl;
        else
          fp<< "<BR>" << endl;
      }
      else {
	fp << "<TR><TD><B>";
        if ( strcmp( link, "") != 0)
          fp << "<A HREF=\"" <<  fname << "\">";
        else if ( bookmark != 0)
          fp << "<A NAME=\"" <<  bookmark << "\">";
        fp << text1;
        if ( strcmp( link, "") != 0 || bookmark)
	  fp << "</A>";
        if ( strcmp( text2, "") != 0 || strcmp( text3, "") != 0) {
          for ( i = 0; i < (int)(CNV_TAB - strlen(text1)); i++)
            fp << "&nbsp;";
          fp << "&nbsp;&nbsp;</B></TD><TD><B>" << text2;
          if ( strcmp( text3, "") != 0) {
            for ( i = 0; i < (int)(CNV_TAB - strlen(text2)); i++)
              fp << "&nbsp;";
            fp << "&nbsp;&nbsp;</B></TD><TD><B>" << text3;
          }
        }
        fp << "</B></TD></TR>";
        if ( strcmp( link, "") != 0 || bookmark)
          fp << "</A>" << endl;
        else
          fp << endl;
      }
      return NULL;
    }
    case navh_eItemType_HelpHeader:
    {
      fp << "<H1>" << text1 << "</H1><BR>" << endl;
      return NULL;
    }
    case navh_eItemType_Header:
    {      
      fp << "<H3>" << text1 << "</H3><BR>" << endl;
      return NULL;
    }
    case navh_eItemType_HeaderLarge:
    {      
      fp << "<H2>" << text1 << "</H2><BR>" << endl;
      return NULL;
    }
    case navh_eItemType_HorizontalLine:
    {      
      fp << "<HR>" << endl;
      return NULL;
    }
    case navh_eItemType_Image:
    {      
      fp << "<IMG SRC=\"" << text1 << "\"><BR>" << endl;
      return NULL;
    }
    default:
      return 0;
  }
}







